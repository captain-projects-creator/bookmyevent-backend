<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Register â€” Event Booking</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .auth { max-width:420px;margin:40px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.08); transform: translateY(-6px); animation: popIn .28s ease both; }
        @keyframes popIn { from { opacity:0; transform: translateY(-10px) scale(.995) } to { opacity:1; transform: translateY(0) scale(1) } }
        .micro { font-size:13px;color:#6b7280;margin-top:8px }
        .otp-row { display:flex; gap:8px; align-items:center; }
        .btn.ghost { background:transparent;color:var(--accent); border:1px solid #e6f0ff; }
    </style>
</head>
<body>
<div class="auth" role="main" aria-labelledby="reg-title">
    <h2 id="reg-title">Register</h2>

    <label>Username</label>
    <input id="username" placeholder="Choose username">

    <label>Password</label>
    <input id="password" type="password" placeholder="Choose password">

    <label>Email (optional)</label>
    <input id="email" placeholder="you@example.com">

    <label>Mobile (optional)</label>
    <input id="mobile" placeholder="+911234567890">

    <div class="otp-row" style="margin-top:8px;">
        <div style="flex:1">
            <label>OTP</label>
            <input id="otp" placeholder="Enter OTP">
        </div>
        <div style="align-self:flex-end">
            <button id="sendOtpBtn" class="btn ghost small">Send OTP</button>
        </div>
    </div>

    <div style="margin-top:12px;">
        <button id="registerBtn" class="btn">Register</button>
        <a href="login.html" style="margin-left:10px" class="micro">Back to login</a>
    </div>

    <div id="msg" class="micro" style="color:#b91c1c"></div>
    <div id="hint" class="micro" style="color:#059669"></div>
</div>

<script>
    const API = '/api/auth';
    function el(id){ return document.getElementById(id); }
    el('sendOtpBtn').addEventListener('click', async (e) => {
      const email = el('email').value.trim();
      const mobile = el('mobile').value.trim();
      const to = email || mobile;
      if (!to) { el('msg').innerText = 'Provide email or mobile to send OTP'; return; }
      el('msg').innerText = '';
      try {
        const res = await fetch(API + '/send-otp', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to})});
        const body = await res.json();
        if (!res.ok) { el('msg').innerText = body.message || 'Failed to send OTP'; return; }
        el('hint').innerText = `OTP sent. Hint: ${body.masked || ''} (dev)`;
      } catch (err) { el('msg').innerText = 'Error sending OTP: ' + err.message; }
    });

    el('registerBtn').addEventListener('click', async () => {
      el('msg').innerText = '';
      const username = el('username').value.trim();
      const password = el('password').value;
      const email = el('email').value.trim();
      const mobile = el('mobile').value.trim();
      const otp = el('otp').value.trim();

      if (!username || !password) { el('msg').innerText = 'username and password required'; return; }
      if (!email && !mobile) { el('msg').innerText = 'email or mobile required'; return; }
      if (!otp) { el('msg').innerText = 'enter otp sent to your email/mobile'; return; }

      try {
        const payload = { username, password, otp };
        if (email) payload.email = email;
        if (mobile) payload.mobile = mobile;
        const res = await fetch(API + '/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const body = await res.json();
        if (!res.ok) { el('msg').innerText = body.message || 'Registration failed'; return; }
        // auto-login via username/password
        const loginRes = await fetch('/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username, password}) });
        const lb = await loginRes.json();
        if (loginRes.ok && lb.token) {
          localStorage.setItem('token', lb.token);
          window.location.href = 'index.html';
        } else {
          el('hint').innerText = 'Registered. Please login.';
          window.location.href = 'login.html';
        }
      } catch (err) { el('msg').innerText = 'Register error: ' + err.message; }
    });
</script>
</body>
</html>